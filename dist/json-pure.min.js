!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.VueJsonPure=e()}(this,function(){"use strict";var t=function(){this.listeners=new Map};t.prototype.addListener=function(t,e,o){return"function"==typeof e&&(this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push({callback:e,vm:o}),!0)},t.prototype.removeListener=function(t,e,o){var n,s=this.listeners.get(t);return!!(s&&s.length&&(n=s.reduce(function(t,n,s){return"function"==typeof n.callback&&n.callback===e&&n.vm===o&&(t=s),t},-1))>-1)&&(s.splice(n,1),this.listeners.set(t,s),!0)},t.prototype.emit=function(t,e){var o=this.listeners.get(t);if(o&&o.length){for(var n=!0,s=null,i=0;i<o.length&&!0===n;i++)n=!1,(s=o[i]).callback.call(s.vm,e,function(){n=!0});return!0}return!1};var e,o,n,s,i,r=new t,c=function(){function t(t,e){void 0===e&&(e={}),this.format=e.format&&e.format.toLowerCase(),this.connect(t,e),e.store&&(this.store=e.store),this.onEvent()}return t.prototype.connect=function(t,e){var o=this;void 0===e&&(e={});var n=e.protocol||"";this.WebSocket=e.WebSocket||(""===n?new WebSocket(t):new WebSocket(t,n)),"json"===this.format&&("sendObj"in this.WebSocket||(this.WebSocket.sendObj=function(t){return o.WebSocket.send(JSON.stringify(t))}))},t.prototype.onEvent=function(){var t=this;["onmessage","onclose","onerror","onopen"].forEach(function(e){t.WebSocket[e]=function(o){r.emit(e,o),t.store&&t.passToStore("SOCKET_"+e,o)}})},t.prototype.passToStore=function(t,e){if(t.startsWith("SOCKET_")){var o=t.toUpperCase(),n=e;"json"===this.format&&e.data&&(n=JSON.parse(e.data)),this.store.commit(o,n)}},t}(),a=function(t){console.warn("[json-pure] "+t)},u={install:function(t){if(e)a("already installed, Vue.use(VueJsonPure) should only be called once.");else{e=t;var s=new c(o,n);e.prototype.$socket=s.WebSocket,e.mixin({created:function(){var t=this,e=this.$options.sockets;this.$options.sockets=new Proxy({},{set:function(t,e,o){return r.addListener(e,o,this),t[e]=o,!0},deleteProperty:function(t,e){return r.removeListener(e,this.$options.sockets[e],this),delete t.key,!0}}),e&&Object.keys(e).forEach(function(o){t.$options.sockets[o]=e[o]})},beforeDestroy:function(){var t=this,e=this.$options.sockets;e&&Object.keys(e).forEach(function(e){delete t.$options.sockets[e]})}})}},setup:function(t,e){if(void 0===e&&(e={}),!t)throw new Error("[json-pure] the url cannot be empty");o=t,n=e},version:"1.0.0"},p=function(){function t(t){this.socket=t}return t.prototype.create=function(t,e){this.socket.sendObj({action_str:"create",data_type:t,request_map:e})},t.prototype.retrieve=function(t,e){this.socket.sendObj({action_str:"retrieve",data_type:t,request_map:e})},t.prototype.update=function(t,e){this.socket.sendObj({action_str:"update",data_type:t,request_map:e})},t.prototype.delete=function(t,e){this.socket.sendObj({action_str:"delete",data_type:t,request_map:e})},t.prototype.flush=function(t,e){this.socket.sendObj({action_str:"flush",data_type:t,request_map:e})},t}(),f=function(t,e,o){var n=e.action_str.split("_");2===n.length&&"FAIL"===n[1]?(r.emit("fail",{action_str:n[0]}),i.store&&h("API_FAIL",{action_str:n[0]})):(r.emit(n[0],e),i.store&&h("API_"+n[0],e)),o()},h=function(t,e){if(t.startsWith("API_")){var o=t.toUpperCase(),n=e;"json"===i.format&&e&&(n=JSON.parse(e)),i.store.commit(o,n)}};return{install:function(t){if(!s||!i)throw new Error("[json-pure] you have to call setup() before Vue.use()");u.setup(s,i),u.install(t,s,i),t.prototype.$api=new p(t.prototype.$socket),t.mixin({created:function(){var t=this;this.$options.sockets.onmessage=this.websocketOnMessage;var e=this.$options.api;this.$options.api=new Proxy({},{set:function(t,e,o){return r.addListener(e,o,this),t[e]=o,!0},deleteProperty:function(t,e){return r.removeListener(e,this.$options.api[e],this),delete t.key,!0}}),e&&Object.keys(e).forEach(function(o){t.$options.api[o]=e[o]})},beforeDestroy:function(){var t=this,e=this.$options.api;e&&Object.keys(e).forEach(function(e){delete t.$options.api[e]})},methods:{websocketOnMessage:function(t,e){var o=JSON.parse(t.data);!0!==i.autoPong||"PING"!==o.action_str?(f(t,o,e),e()):this.$socket.sendObj({action_str:"PONG"})}}})},setup:function(t,e){if(void 0===e&&(e={}),!t)throw new Error("[json-pure] the url cannot be empty");s=t,i=e},version:"1.0.0"}});